name: ðŸ” CI - Build & Test

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

env:
  APP_NAME: "ClickIt"
  BUNDLE_ID: "com.jsonify.clickit"

jobs:
  build-test:
    name: ðŸ”¨ Build & Test on Xcode
    runs-on: macos-15
    
    strategy:
      matrix:
        build_mode: [debug, release]
        build_system: [xcode, spm]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ” Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: ðŸ“‹ Environment Info
      run: |
        echo "ðŸ–¥ï¸ Runner: macOS $(sw_vers -productVersion)"
        echo "ðŸ”¨ Xcode: $(xcodebuild -version | head -1)"
        echo "ðŸ Swift: $(swift --version | head -1)"
        echo "ðŸ—ï¸ Build Mode: ${{ matrix.build_mode }}"
        echo "ðŸ“¦ Build System: ${{ matrix.build_system }}"
    
    - name: ðŸ§ª Run Swift Tests
      if: matrix.build_system == 'spm'
      run: |
        echo "ðŸ§ª Running Swift Package Manager tests..."
        swift test --verbose
    
    - name: ðŸ§ª Run Xcode Tests  
      if: matrix.build_system == 'xcode'
      run: |
        echo "ðŸ§ª Running Xcode tests..."
        xcodebuild test -project ClickIt.xcodeproj -scheme ClickIt -destination 'platform=macOS' || echo "âš ï¸ No tests configured in Xcode project"
    
    - name: ðŸ—ï¸ Build App Bundle
      run: |
        echo "ðŸ”¨ Building ${{ env.APP_NAME }} (${{ matrix.build_mode }} mode, ${{ matrix.build_system }} system)..."
        if [ "${{ matrix.build_system }}" = "xcode" ]; then
          # For Xcode builds in CI, disable code signing and set deployment target
          export CODE_SIGN_IDENTITY=""
          export CODE_SIGNING_REQUIRED=NO
          export CODE_SIGNING_ALLOWED=NO
          export MACOSX_DEPLOYMENT_TARGET=15.0
        fi
        ./build_app_unified.sh ${{ matrix.build_mode }} ${{ matrix.build_system }}
        
        echo "ðŸ“‹ Build completed!"
        ls -la dist/
    
    - name: ðŸ” Verify Build Output
      run: |
        echo "ðŸ” Verifying build output..."
        
        if [ -d "dist/${{ env.APP_NAME }}.app" ]; then
          echo "âœ… App bundle created successfully"
          
          # Check app bundle structure
          echo "ðŸ“ App bundle contents:"
          find "dist/${{ env.APP_NAME }}.app" -type f | head -10
          
          # Check binary architecture
          BINARY_PATH="dist/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}"
          if [ -f "$BINARY_PATH" ]; then
            echo "ðŸ“± Binary info:"
            file "$BINARY_PATH"
            echo "ðŸ—ï¸ Architecture:"
            lipo -info "$BINARY_PATH" 2>/dev/null || echo "Single architecture binary"
          else
            echo "âŒ Binary not found at $BINARY_PATH"
            exit 1
          fi
          
          # Check code signing status
          echo "ðŸ” Code signing status:"
          codesign -dv "dist/${{ env.APP_NAME }}.app" 2>&1 || echo "âš ï¸ Not code signed"
          
        else
          echo "âŒ App bundle not found!"
          exit 1
        fi
    
    - name: ðŸ“¦ Upload Build Artifacts
      if: matrix.build_mode == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: "${{ env.APP_NAME }}-${{ matrix.build_system }}-${{ github.sha }}"
        path: |
          dist/${{ env.APP_NAME }}.app
          dist/build-info.txt
        retention-days: 7

  lint-and-quality:
    name: ðŸ” Code Quality & Linting
    runs-on: macos-15
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ” Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: ðŸ“Š Swift Package Dependencies
      run: |
        echo "ðŸ“Š Checking Swift Package dependencies..."
        swift package show-dependencies || echo "âš ï¸ No Package.swift or dependencies found"
    
    - name: ðŸ”’ Security Check (Basic)
      run: |
        echo "ðŸ”’ Basic security checks..."
        echo "ðŸ” Checking for hardcoded secrets..."
        
        # Check for common secret patterns (basic check)
        if grep -r -i "password\|secret\|token\|key" --include="*.swift" Sources/ || true; then
          echo "âš ï¸ Found potential secrets - please review manually"
        else
          echo "âœ… No obvious secrets found in Swift source"
        fi
        
        echo "ðŸ” Checking for insecure HTTP URLs..."
        if grep -r "http://" --include="*.swift" Sources/ || true; then
          echo "âš ï¸ Found HTTP URLs - consider using HTTPS"
        else
          echo "âœ… No insecure HTTP URLs found"
        fi

  summary:
    name: ðŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [build-test, lint-and-quality]
    if: always()
    
    steps:
    - name: ðŸ“Š CI Results Summary
      run: |
        echo "## ðŸ“‹ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Test | ${{ needs.build-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.lint-and-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-test.result }}" = "success" ] && [ "${{ needs.lint-and-quality.result }}" = "success" ]; then
          echo "ðŸŽ‰ **All checks passed!** The code is ready for release." >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Some checks failed.** Please review the results above." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- **For Release**: Create a version tag (e.g., \`git tag v1.3.0 && git push origin v1.3.0\`)" >> $GITHUB_STEP_SUMMARY
        echo "- **For Development**: Merge to main branch when ready" >> $GITHUB_STEP_SUMMARY
